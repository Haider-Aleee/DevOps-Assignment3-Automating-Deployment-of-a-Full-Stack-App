name: CI/CD Workflow for Testing the PR requests

run-name: >+
    Testing workflow triggered by ${{ github.actor }}
    on branch: ${{ github.ref_name }}
    on event: ${{ github.event_name }}
    on repository: ${{ github.repository }}

on:
  pull_request:
    branches:
      - main

  workflow_dispatch:

jobs:
    lint-and-test:
        name: Code Analysis, Linting, and Unit Testing
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '18'
                  cache: npm
            
            - name: Install Frontend dependencies
              run: cd Frontend && npm ci

            - name: Install Backend dependencies
              run: cd Backend && npm ci

            - name: Run Frontend Code Analysis (ESLint)
              run: |
                cd Frontend
                # ESLint is included with react-scripts, run it directly
                npx eslint src/ --ext .js,.jsx --format compact || echo "ESLint check completed with warnings"
              continue-on-error: true

            - name: Run Backend Code Analysis
              run: |
                cd Backend
                # Check if eslint is available, if not skip
                if [ -f node_modules/.bin/eslint ]; then
                  npx eslint *.js || echo "ESLint check completed"
                else
                  echo "ESLint not configured for backend, skipping"
                fi
              continue-on-error: true

            - name: Run Frontend Unit Tests
              run: cd Frontend && npm test -- --watchAll=false --coverage

            - name: Run Backend Unit Tests
              run: cd Backend && npm test

    build:
        name: Building the React App
        runs-on: ubuntu-latest
        needs: lint-and-test
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '18'
                  cache: npm

            - name: Install Frontend dependencies
              run: cd Frontend && npm ci

            - name: Install Backend dependencies
              run: cd Backend && npm ci

            - name: Build the React App
              run: cd Frontend && npm run build

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                name: react-app-build
                path: Frontend/build/
                retention-days: 1

    deploy:
        name: Deploying to AWS EC2 Testing Environment
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                name: react-app-build
                path: Frontend/build/

            - name: Configure SSH
              run: |
                mkdir -p ~/.ssh
                echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
                chmod 600 ~/.ssh/deploy_key
                ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy to EC2 Instance
              env:
                EC2_HOST: ${{ secrets.EC2_HOST }}
                EC2_USER: ${{ secrets.EC2_USER }}
                EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
              run: |
                # Create deployment directory structure
                ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                  mkdir -p ~/ReactNodeTesting
                  mkdir -p ~/ReactNodeTesting/Frontend
                  mkdir -p ~/ReactNodeTesting/Backend
                EOF

                # Copy build files
                scp -i ~/.ssh/deploy_key -r Frontend/build/* ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/ReactNodeTesting/Frontend/build/

                # Copy backend files
                scp -i ~/.ssh/deploy_key -r Backend/* ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/ReactNodeTesting/Backend/

                # Copy package.json files
                scp -i ~/.ssh/deploy_key package.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/ReactNodeTesting/
                scp -i ~/.ssh/deploy_key Frontend/package.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/ReactNodeTesting/Frontend/
                scp -i ~/.ssh/deploy_key Backend/package.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/ReactNodeTesting/Backend/

                # Install dependencies and restart application on EC2
                ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                  cd ~/ReactNodeTesting
                  cd Backend && npm install --production
                  cd ..
                  
                  # Install PM2 if not already installed
                  if ! command -v pm2 &> /dev/null; then
                    npm install -g pm2
                  fi
                  
                  # Stop existing application if running
                  sudo pm2 stop react-node-app || true
                  sudo pm2 delete react-node-app || true
                  
                  # Start the application on port 80
                  cd Backend
                  # Use sudo for port 80 (requires root privileges for ports < 1024)
                  sudo PORT=80 pm2 start index.js --name react-node-app
                  sudo pm2 save
                  
                  # Save PM2 startup script
                  sudo pm2 startup systemd -u $USER --hp $HOME || true
                EOF

            - name: Get EC2 Instance IP
              id: get_ip
              run: |
                echo "instance_ip=${{ secrets.EC2_HOST }}" >> $GITHUB_OUTPUT

            - name: Send Success Email Notification
              if: success()
              uses: dawidd6/action-send-mail@v3
              with:
                server_address: smtp.gmail.com
                server_port: 465
                username: ${{ secrets.EMAIL_USERNAME }}
                password: ${{ secrets.EMAIL_PASSWORD }}
                subject: "✅ Deployment Successful - QA Testing Ready"
                to: ${{ secrets.QA_EMAIL }},${{ github.event.pull_request.user.email }}
                from: GitHub Actions
                html_body: |
                  <h2>Deployment Successful!</h2>
                  <p>The application has been successfully deployed to the AWS EC2 testing environment.</p>
                  
                  <h3>Deployment Details:</h3>
                  <ul>
                    <li><strong>Repository:</strong> ${{ github.repository }}</li>
                    <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
                    <li><strong>Commit:</strong> ${{ github.sha }}</li>
                    <li><strong>Triggered by:</strong> ${{ github.actor }}</li>
                    <li><strong>Pull Request:</strong> ${{ github.event.pull_request.html_url || 'Manual Trigger' }}</li>
                  </ul>
                  
                  <h3>Access the Application:</h3>
                  <p><strong>URL:</strong> <a href="http://${{ secrets.EC2_HOST }}">http://${{ secrets.EC2_HOST }}</a></p>
                  
                  <h3>Testing Instructions:</h3>
                  <ol>
                    <li>Open your browser and navigate to: <strong>http://${{ secrets.EC2_HOST }}</strong></li>
                    <li>Test the shopping cart functionality</li>
                    <li>Verify API endpoints are working: <strong>http://${{ secrets.EC2_HOST }}/api/carts/777</strong></li>
                    <li>Check all features as per the test plan</li>
                  </ol>
                  
                  <p>Please test the deployed application and provide feedback.</p>
                  
                  <p>Best regards,<br>GitHub Actions CI/CD Pipeline</p>

    notify-failure:
        name: Send Failure Notification
        runs-on: ubuntu-latest
        needs: [lint-and-test, build, deploy]
        if: failure()
        steps:
            - name: Send Failure Email Notification
              uses: dawidd6/action-send-mail@v3
              with:
                server_address: smtp.gmail.com
                server_port: 465
                username: ${{ secrets.EMAIL_USERNAME }}
                password: ${{ secrets.EMAIL_PASSWORD }}
                subject: "❌ Workflow Failed - ${{ github.repository }}"
                to: ${{ secrets.QA_EMAIL }},${{ github.event.pull_request.user.email }}
                from: GitHub Actions
                html_body: |
                  <h2>Workflow Failed!</h2>
                  <p>The CI/CD workflow has failed. Please review the errors and fix them before merging.</p>
                  
                  <h3>Failure Details:</h3>
                  <ul>
                    <li><strong>Repository:</strong> ${{ github.repository }}</li>
                    <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
                    <li><strong>Commit:</strong> ${{ github.sha }}</li>
                    <li><strong>Triggered by:</strong> ${{ github.actor }}</li>
                    <li><strong>Pull Request:</strong> ${{ github.event.pull_request.html_url || 'Manual Trigger' }}</li>
                    <li><strong>Workflow Run:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Run</a></li>
                  </ul>
                  
                  <p>Please check the workflow logs for detailed error information.</p>
                  
                  <p>Best regards,<br>GitHub Actions CI/CD Pipeline</p>
