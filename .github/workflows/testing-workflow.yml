name: CI/CD Workflow for Testing the PR requests

run-name: >+
    Testing workflow triggered by ${{ github.actor }}
    on branch: ${{ github.ref_name }}
    on event: ${{ github.event_name }}
    on repository: ${{ github.repository }}

on:
  pull_request:
    branches:
      - main

  workflow_dispatch:

jobs:
    lint-and-test:
        name: Code Analysis, Linting, and Unit Testing
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '18'
                  cache: npm
            
            - name: Install Frontend dependencies
              run: cd Frontend && npm ci

            - name: Install Backend dependencies
              run: cd Backend && npm ci

            - name: Run Frontend Code Analysis (ESLint)
              run: |
                cd Frontend
                # ESLint is included with react-scripts, run it directly
                npx eslint src/ --ext .js,.jsx --format compact || echo "ESLint check completed with warnings"
              continue-on-error: true

            - name: Run Backend Code Analysis
              run: |
                cd Backend
                # Check if eslint is available, if not skip
                if [ -f node_modules/.bin/eslint ]; then
                  npx eslint *.js || echo "ESLint check completed"
                else
                  echo "ESLint not configured for backend, skipping"
                fi
              continue-on-error: true

            - name: Run Frontend Unit Tests
              run: cd Frontend && npm test -- --watchAll=false --coverage

            - name: Run Backend Unit Tests
              run: cd Backend && npm test

    build:
        name: Building the React App
        runs-on: ubuntu-latest
        needs: lint-and-test
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '18'
                  cache: npm

            - name: Install Frontend dependencies
              run: cd Frontend && npm ci

            - name: Install Backend dependencies
              run: cd Backend && npm ci

            - name: Build the React App
              run: cd Frontend && npm run build

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                name: react-app-build
                path: Frontend/build/
                retention-days: 1

    build-and-push-docker:
        name: Build and Push Docker Images to ECR
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: ${{ secrets.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push Frontend Docker image
              env:
                ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                ECR_REPOSITORY: ${{ secrets.ECR_FRONTEND_REPO }}
                IMAGE_TAG: ${{ github.sha }}
              run: |
                docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest ./Frontend
                docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
                docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
                echo "Frontend image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

            - name: Build and push Backend Docker image
              env:
                ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                ECR_REPOSITORY: ${{ secrets.ECR_BACKEND_REPO }}
                IMAGE_TAG: ${{ github.sha }}
              run: |
                docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest ./Backend
                docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
                docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
                echo "Backend image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

    deploy:
        name: Deploying to AWS EC2 Testing Environment
        runs-on: ubuntu-latest
        needs: [build, build-and-push-docker]
        if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                name: react-app-build
                path: Frontend/build/

            - name: Configure SSH
              timeout-minutes: 2
              run: |
                mkdir -p ~/.ssh
                echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
                chmod 600 ~/.ssh/deploy_key
                ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

            - name: Test SSH Connection
              timeout-minutes: 1
              run: |
                echo "Testing SSH connection..."
                ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH connection successful'"

            - name: Deploy to EC2 Instance
              timeout-minutes: 10
              env:
                EC2_HOST: ${{ secrets.EC2_HOST }}
                EC2_USER: ${{ secrets.EC2_USER }}
                EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
              run: |
                set -e
                echo "Starting deployment..."
                
                # Create deployment directory structure
                echo "Creating directories..."
                ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                  mkdir -p ~/ReactNodeTesting
                  mkdir -p ~/ReactNodeTesting/Frontend/build
                  mkdir -p ~/ReactNodeTesting/Backend
                EOF

                # Copy build files
                echo "Copying frontend build files..."
                scp -i ~/.ssh/deploy_key -o ConnectTimeout=10 -r Frontend/build/* ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/ReactNodeTesting/Frontend/build/

                # Copy backend files
                echo "Copying backend files..."
                scp -i ~/.ssh/deploy_key -o ConnectTimeout=10 -r Backend/* ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/ReactNodeTesting/Backend/

                # Copy package.json files
                echo "Copying package.json files..."
                scp -i ~/.ssh/deploy_key -o ConnectTimeout=10 package.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/ReactNodeTesting/
                scp -i ~/.ssh/deploy_key -o ConnectTimeout=10 Frontend/package.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/ReactNodeTesting/Frontend/
                scp -i ~/.ssh/deploy_key -o ConnectTimeout=10 Backend/package.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/ReactNodeTesting/Backend/

                # Install dependencies and restart application on EC2
                echo "Installing dependencies and starting application..."
                ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                  set -e
                  cd ~/ReactNodeTesting
                  
                  echo "Installing backend dependencies..."
                  cd Backend && npm install --production --no-audit --no-fund
                  cd ..
                  
                  # Install PM2 if not already installed
                  if ! command -v pm2 &> /dev/null; then
                    echo "Installing PM2..."
                    npm install -g pm2
                  fi
                  
                  # Stop existing application if running
                  echo "Stopping existing application..."
                  pm2 stop react-node-app 2>/dev/null || true
                  pm2 delete react-node-app 2>/dev/null || true
                  
                  # Start the application on port 80
                  echo "Starting application on port 80..."
                  cd Backend
                  # Use sudo for port 80 (requires root privileges for ports < 1024)
                  # Note: This requires passwordless sudo or NOPASSWD in sudoers
                  sudo PORT=80 pm2 start index.js --name react-node-app
                  sudo pm2 save
                  
                  echo "Deployment completed successfully!"
                  pm2 list
                EOF

            - name: Get EC2 Instance IP
              id: get_ip
              run: |
                echo "instance_ip=${{ secrets.EC2_HOST }}" >> $GITHUB_OUTPUT

            - name: Send Success Email Notification
              if: success()
              uses: dawidd6/action-send-mail@v3
              with:
                server_address: smtp.gmail.com
                server_port: 465
                username: ${{ secrets.EMAIL_USERNAME }}
                password: ${{ secrets.EMAIL_PASSWORD }}
                subject: "✅ Deployment Successful - QA Testing Ready"
                to: ${{ secrets.QA_EMAIL }},${{ github.event.pull_request.user.email }}
                from: GitHub Actions
                html_body: |
                  <h2>Deployment Successful!</h2>
                  <p>The application has been successfully deployed to the AWS EC2 testing environment.</p>
                  
                  <h3>Deployment Details:</h3>
                  <ul>
                    <li><strong>Repository:</strong> ${{ github.repository }}</li>
                    <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
                    <li><strong>Commit:</strong> ${{ github.sha }}</li>
                    <li><strong>Triggered by:</strong> ${{ github.actor }}</li>
                    <li><strong>Pull Request:</strong> ${{ github.event.pull_request.html_url || 'Manual Trigger' }}</li>
                  </ul>
                  
                  <h3>Access the Application:</h3>
                  <p><strong>URL:</strong> <a href="http://${{ secrets.EC2_HOST }}">http://${{ secrets.EC2_HOST }}</a></p>
                  
                  <h3>Testing Instructions:</h3>
                  <ol>
                    <li>Open your browser and navigate to: <strong>http://${{ secrets.EC2_HOST }}</strong></li>
                    <li>Test the shopping cart functionality</li>
                    <li>Verify API endpoints are working: <strong>http://${{ secrets.EC2_HOST }}/api/carts/777</strong></li>
                    <li>Check all features as per the test plan</li>
                  </ol>
                  
                  <p>Please test the deployed application and provide feedback.</p>
                  
                  <p>Best regards,<br>GitHub Actions CI/CD Pipeline</p>

    notify-failure:
        name: Send Failure Notification
        runs-on: ubuntu-latest
        needs: [lint-and-test, build, deploy]
        if: failure()
        steps:
            - name: Send Failure Email Notification
              uses: dawidd6/action-send-mail@v3
              with:
                server_address: smtp.gmail.com
                server_port: 465
                username: ${{ secrets.EMAIL_USERNAME }}
                password: ${{ secrets.EMAIL_PASSWORD }}
                subject: "❌ Workflow Failed - ${{ github.repository }}"
                to: ${{ secrets.QA_EMAIL }},${{ github.event.pull_request.user.email }}
                from: GitHub Actions
                html_body: |
                  <h2>Workflow Failed!</h2>
                  <p>The CI/CD workflow has failed. Please review the errors and fix them before merging.</p>
                  
                  <h3>Failure Details:</h3>
                  <ul>
                    <li><strong>Repository:</strong> ${{ github.repository }}</li>
                    <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
                    <li><strong>Commit:</strong> ${{ github.sha }}</li>
                    <li><strong>Triggered by:</strong> ${{ github.actor }}</li>
                    <li><strong>Pull Request:</strong> ${{ github.event.pull_request.html_url || 'Manual Trigger' }}</li>
                    <li><strong>Workflow Run:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Run</a></li>
                  </ul>
                  
                  <p>Please check the workflow logs for detailed error information.</p>
                  
                  <p>Best regards,<br>GitHub Actions CI/CD Pipeline</p>
